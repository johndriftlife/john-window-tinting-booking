import { useEffect, useState } from 'react'
const API=process.env.NEXT_PUBLIC_API_BASE_URL||''
export default function Home(){const[s,setS]=useState([]);const[sid,setSid]=useState('');const[sh,setSh]=useState([]);const[n,setN]=useState('');const[p,setP]=useState('');const[b,setB]=useState('');const[m,setM]=useState('');const[d,setD]=useState('');const[t,setT]=useState('');const[ts,setTs]=useState([]);const[msg,setMsg]=useState('');const[ok,setOk]=useState(false);useEffect(()=>{if(API)fetch(`${API}/api/services`).then(r=>r.json()).then(setS).catch(()=>{})},[]);useEffect(()=>{if(API&&sid)fetch(`${API}/api/shades?serviceId=${sid}`).then(r=>r.json()).then(setSh).catch(()=>{})},[sid]);async function loadTimes(){setTs([]);setT('');setMsg('');setOk(false);if(!d)return;try{const r=await fetch(`${API}/api/availability?date=${d}`);const data=await r.json();setTs(data.slots||[]);if(!(data.slots||[]).length)setMsg('No times available for that date.')}catch{setMsg('Could not load availability.')}}async function submit(e){e.preventDefault();setMsg('');setOk(false);if(!API){setMsg('Set NEXT_PUBLIC_API_BASE_URL.');return}try{const r=await fetch(`${API}/api/book`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,phone:p,brand:b,model:m,serviceId:Number(sid),shade:document.getElementById('shade')?.value||'',date:d,time:t})});const data=await r.json();if(!r.ok)throw new Error(data.error||'Error');setOk(true);setMsg('Booked!')}catch(err){setMsg(err.message)}}return(<div className='container'><div className='logo-wrap'><img className='logo' src='/logo.png' alt='John Window Tinting' /></div><div className='center'><a href='/admin-settings' className='btn'>Go to Admin Settings</a></div><h1>Book an Appointment</h1><form onSubmit={submit}><div className='row'><label>Name<input value={n} onChange={e=>setN(e.target.value)} placeholder='Full name' required/></label><label>Phone Number<input type='tel' value={p} onChange={e=>setP(e.target.value)} placeholder='(555) 555-5555' required/></label></div><div className='row'><label>Vehicle Brand<input value={b} onChange={e=>setB(e.target.value)} placeholder='e.g., Toyota'/></label><label>Vehicle Model<input value={m} onChange={e=>setM(e.target.value)} placeholder='e.g., Camry'/></label></div><label>Select service<select value={sid} onChange={e=>setSid(e.target.value)} required><option value='' disabled>Choose service</option>{s.map(x=><option key={x.id} value={x.id}>{x.name}</option>)}</select></label>{sid&&(<label>Tint Shade<select id='shade' defaultValue='' required><option value='' disabled>Select shade</option>{sh.map(opt=><option key={opt} value={opt}>{opt}</option>)}</select></label>)}<label>Date availability<input type='date' value={d} onChange={e=>setD(e.target.value)} onBlur={loadTimes} required/></label><label>Time<select value={t} onChange={e=>setT(e.target.value)} required><option value='' disabled>{ts.length?'Select a time':'Choose a date first'}</option>{ts.map(q=><option key={q.time} value={q.time}>{q.label}</option>)}</select></label>{msg&&<div style={{color:ok?'#7CFC00':'#ff6b6b'}}>{msg}</div>}<button type='submit'>Book Appointment</button></form></div>)}